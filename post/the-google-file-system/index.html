<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Smy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="A student who is constantly striving"/>
<meta name="keywords" content="A student who is constantly striving"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://saseke.github.io/favicon.ico">

<link rel="stylesheet" href="https://saseke.github.io/styles/main.css">

<!-- Modernizr JS -->
<script src="https://saseke.github.io/media/scripts/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://saseke.github.io/media/scripts/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->



<!-- katex -->
<!--<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">-->

<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://saseke.github.io/images/avatar.png" alt="Smy"
                 class="img-responsive">
        </figure>
        <a href="https://saseke.github.io/post/about/"><h3 class="heading">ABOUT ME</h3></a>
        <h2>Smy</h2>
        <p>A student who is constantly striving</p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">

        <!-- 标签 -->
        <div class="fh5co-box">
            <a href="https://saseke.github.io/tags/"><h3 class="heading">👉标签</h3></a>
            <ul>
                
                    <li><a href="https://saseke.github.io/tag/ugAnwOalE/">paper</a></li>
                
                    <li><a href="https://saseke.github.io/tag/algorithm/">algorithm</a></li>
                
                    <li><a href="https://saseke.github.io/tag/diary/">diary</a></li>
                
                    <li><a href="https://saseke.github.io/tag/AwsgcjQkK/">c++</a></li>
                
                    <li><a href="https://saseke.github.io/tag/lbnI2Wnls/">distributed</a></li>
                
                    <li><a href="https://saseke.github.io/tag/tZS19L4dr/">file system</a></li>
                
                    <li><a href="https://saseke.github.io/tag/vT5ZzxYvS/">redis</a></li>
                
                    <li><a href="https://saseke.github.io/tag/JEV3JRwPx/">architecture</a></li>
                
                    <li><a href="https://saseke.github.io/tag/mgPa4qhSL/">storm</a></li>
                
                    <li><a href="https://saseke.github.io/tag/rVd9T6I6y/">hbase</a></li>
                
                    <li><a href="https://saseke.github.io/tag/RnNn2Kd83/">hive</a></li>
                
                    <li><a href="https://saseke.github.io/tag/eExHX0970/">leetcode</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/"
                        
                        >
                            HomePage
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives"
                        
                        >
                            Archive
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                        
                        >
                            Tag
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/about"
                        
                        >
                            About
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://saseke.github.io">Smy </a>
                </h1>
            </div>
        </div>
    </div>
</header>


    <!--  <a href="#" class="fh5co-post-prev"><span>👈 Prev</span></a>-->
    <!--  <a href="#" class="fh5co-post-next"><span>Next 👉</span></a>-->

    <!-- 等gridea出自定义页面功能再优化一下 -->
    
        <div class="container-fluid">
    <div class="row fh5co-post-entry single-entry">
        <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
            <figure class="animate-box">
                
                    <img src="https://saseke.github.io/post-images/the-google-file-system.png" alt="The Google File System" class="img-responsive">
                
            </figure>
            <span class="fh5co-meta animate-box">
                
                    <div class="tag-container">
                        
                            <a href="https://saseke.github.io/tag/tZS19L4dr/" class="tag">file system, </a>
                        
                    </div>
                
            </span>
            <h2 class="fh5co-article-title animate-box">The Google File System</h2>
            <ol class="breadcrumb fh5co-meta fh5co-date animate-box" style="margin-bottom:0; background-color:#f8f9fa">
                <li>2022-05-24</li>
                <li>2416字</li>
                <li>9 min read</li>
            </ol>

            <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                <div class="row">
                    <div class="col-md-12 animate-box post-content">
                        <p> <h1 id="the-google-file-system"><strong>The Google File System</strong></h1>
<h2 id="1-introduction">1. <strong>Introduction</strong></h2>
<ul>
<li>
<p>GFS是由数百台甚至数千台廉价的存储及其组成，并且支持大量的客户端进行访问。系统必不可少的5个功能：持续监控，错误检测，容错和自动恢复。</p>
</li>
<li>
<p>GFS引入了原子追加操作，以便多个客户端可以并发的追加一个文件，而不需要进行额外的同步。</p>
</li>
</ul>
<h2 id="2-设计概述">2. <strong>设计概述</strong></h2>
<h3 id="21-assumptions">2.1 Assumptions</h3>
<ul>
<li>该系统由许多<strong>经常失效的廉价商品</strong>组件组成。它必须不断地监控自己，并在日常基础上检测、<strong>容忍和迅速从组件故障中恢复</strong></li>
<li>系统存储的文件数量应该很多，每个文件大小通常为100MB甚至更大。但是也需要支持 小文件，但是不需要针对小文件进行优化</li>
<li>提供大流的连续读取和小流的随机读取</li>
<li>支持类似于读大小的写操作</li>
<li>支持并发写操作</li>
<li>高带宽</li>
</ul>
<h2 id="22-interface">2.2 Interface</h2>
<p>GFS提供了熟悉的文件系统，采用的目录层级结构，但是没有实现标准的API。GFS支持常规的create,delete,open,close,read,write 操作。</p>
<p><strong>GFS支持snapshot和record append功能</strong></p>
<ul>
<li>Snapshot: 支持非常小的开销存储文件的一份副本</li>
<li>record append: 支持多客户端并发追加数据到一个文件</li>
</ul>
<h2 id="23-architecture">2.3 Architecture</h2>
<p><img src="https://saseke.github.io/post-images/1653477093760.png" alt="" loading="lazy"><br>
GFS流程：</p>
<ol>
<li>使用固定大小的块，client将文件名字和位偏移量转换成对应的块编号。</li>
<li>client发送给master:file name and chunk index</li>
<li>server端返回chunk handle(句柄)和副本位置</li>
<li>client缓存该信息
<ul>
<li>Key: filename + chunk index</li>
<li>Value: chunk handle + the locatio of replica.</li>
</ul>
</li>
<li>client发送请求给距离自己最近的一个chunk server.氢气指定了在一个chunk中chunk handle 和 a byte range</li>
<li>之后client不再与master交互获取该数据信息，通过缓存存储在本地。只有当缓存的数据过期或者位置信息发生改变的时候，再重新拉取数据</li>
</ol>
<p>GFS是由一个master节点，多个chunkserver构成。每一个节点都可以是一台单独的linux主机。</p>
<ul>
<li>文件被划分为固定大小的块，每一个块都有一个不可变的全局64位块句柄标示，该标示在块创建时由master节点进行分配</li>
<li>chunkserver存储了多个块</li>
<li>master节点维护着块节点的namespace,访问控制权限等信息</li>
<li>master与chunkserver周期性的进行心跳检测，检测chunkserver的状态</li>
<li>客户端从master节点获取metadata,从chunkserver获取具体的数据</li>
</ul>
<h2 id="24-single-master">2.4 Single master</h2>
<p>单个master可以简化很多操作，可以实现许多复杂的块分配策略。通常master节点不会进行大量的读写操作。client与master交互，只是获得如何与chunkserver进行交互。数据的交互更多的是在client与chunkserver之间进行。</p>
<h2 id="25-chunk-size">2.5 chunk size</h2>
<p>默认分配相较于普通的文件系统更大的chunk 块大小---64MB</p>
<p>增加块大小的优势:</p>
<ol>
<li>可以减少client与master节点交互的次数</li>
<li>正是由于chunk size非常大，client可以在chunk上做更多的操作。从而维护一个tcp连接，同时节省了网络开销</li>
<li>减少了metadata的大小，这可以使我们将metadata存储到内存中</li>
</ol>
<h2 id="26-metadata">2.6 metadata</h2>
<p>metadata中主要包含了三种元数据信息：文件和块的名称空间，从文件到快的映射关系，每个块副本的位置。<strong>所有数据都是存放在master节点的内存中</strong></p>
<p>文件和块的名称，从文件到块的映射关系会通过将变换记录存储到master的本地磁盘的操作日志中，用于复制到远程机器上进行持久化操作</p>
<h3 id="261-in-memory-data-structures">2.6.1 In-memory data structures</h3>
<p>正是由于数据在内存中，master可以周期性的扫描数据，用于实现垃圾收集，块服务器出现故障的时候，数据的重新复制和块迁移以平衡chunkserver负载和磁盘空间。</p>
<p>存在的问题：存储的chunk的信息会受到master内存空间大小的限制</p>
<h3 id="262-chunk-locations">2.6.2 Chunk locations</h3>
<p>主服务器不会保存关于哪个块服务器拥有给定块的副本。它只是在启动的时候轮训块服务器获取这些信息。（这论文说的，我感觉自相矛盾）</p>
<h3 id="263-operation-log">2.6.3 Operation log</h3>
<p>Operation log 定义了重要的metadata数据的变化。</p>
<p>master可以由operation log进行数据恢复</p>
<h2 id="27-consistency-model-说的不是人话">2.7 Consistency Model--说的不是人话</h2>
<p>GFS很好的支持了高分布式，但仍然有着相对简单和有效的实现</p>
<h3 id="271-guarantees-by-gfs">2.7.1 Guarantees by GFS</h3>
<p>通过使用namespace lock实现文件创建具有原子性。</p>
<h1 id="3系统交互">3.<strong>系统交互</strong></h1>
<p>设计系统的目的最小化master在所有操作中的相关度。会讨论client,master,chunkserver如何交互来实现数据的变更，record的原子append,以及快照</p>
<h2 id="31-租约与变更顺序">3.1 租约与变更顺序</h2>
<p>多个副本数据需要保持数据一致性，我们使用租约来实现数据一致性。Master授权给其中一个chunk租约，我们叫做主副本（primary）。主副本会对该chunk的所有变更选择一个顺序，然后所有的副本就会按照这个顺序去应用这些变更。因此，全局的变更顺序首先由master来选择租约授权的顺序来确定的（如果多个chunk修改，master顺序对给他们进行租约授权，授权其实就是选一个primary来进一步处理），然后在一个租约里面的是交给primary副本来定义操作顺序的。</p>
<h2 id="32-数据流">3.2 数据流</h2>
<p>数据在chunkserver中的传输是链式传输的。这样可以充分发挥每个机器的带宽，而不会实现被多个接收者所切分。</p>
<h2 id="33-原子性的记录append">3.3 原子性的记录append</h2>
<p>我们使用了record append方式解决了多个client像同一个chunk中写入数据</p>
<h2 id="34-快照">3.4 快照</h2>
<p>通过写时拷贝技术实现快照，通过本地的chunk进行拷贝，然后将client的请求转移到新的chunk上，从而实现chunk拷贝</p>
<p>COW（写时拷贝）原理是如果被Snapshot的文件有更新操作时，就将文件的要被更新的chunk复制一份，然后对复制的chunk进行更新，而原来的chunk作为快照数据被保留，以后要恢复到该快照时，直接将该chunk读出即可。</p>
<h1 id="4-master操作"><strong>4. master操作</strong></h1>
<p>master执行所有的namespace操作，另外他还管理着整个系统的chunk副本：如决定如何放置，创建一个新的chunk以及其副本，协调整个系统的活动来保证chunk都被完整的备份的，对所以的chunkserver负载均衡，以及回收未使用的存储空间。现在我们将分别讨论这些主题。</p>
<h2 id="41-namespace管理和锁">4.1 namespace管理和锁</h2>
<p>namespace管理：采用树状结构(在内存中构建一颗b+树)对namespace进行管理。</p>
<p>锁：对目录只赋予读权限，对文件赋予写权限。这样有效的避免了目录的删除，重命名</p>
<h2 id="42-备份放置">4.2 备份放置</h2>
<p>备份不止需要放在同机架上，还应该在不同的机架上也存有备份。</p>
<h2 id="43-备份创建重备份重平衡">4.3 备份创建，重备份，重平衡</h2>
<ul>
<li>创建： 当master创建一个chunk时，就需要去创建对应的备份数据</li>
<li>重备份： 当chunk的备份数量小于一定的数量的时候，就需要进行重新备份。</li>
<li>重新平衡：master会检查当前的副本分布，会移动副本，实现平衡磁盘空间</li>
</ul>
<h2 id="44-垃圾回收-文件延迟回收而不是直接删除">4.4 垃圾回收----文件延迟回收，而不是直接删除</h2>
<p>在一个文件删除之后，GFS不会马上释放可用的物理存储，而是延迟回收</p>
<h3 id="441-机制">4.4.1 机制</h3>
<p>当一个文件被删除之后，实际上只是改了一个名字。再master扫描文件超过三天之后，如果该文件还存在，那么就会对其进行删除操作-------master上的namespace会删除对应的隐藏文件名，这样就切断了与chunk的关联。</p>
<h2 id="45-过期副本检测">4.5 过期副本检测</h2>
<p>通过使用版本号策略，来实现过期副本检测</p>
<h1 id="5容错和诊断">5.容错和诊断</h1>
<h2 id="51-高可用">5.1 高可用</h2>
<p>通过使用简单的方法实现系统的高可用。：<strong>快速恢复</strong>，<strong>备份</strong></p>
<ul>
<li>
<p>快速恢复</p>
<p>master和chunkserver两者都设计成无论他们如何被终止都可以在几秒内恢复他们的状态并启动。</p>
</li>
<li>
<p>chunk备份</p>
<p>每一个hcunk都在别的机架上都存有备份</p>
</li>
<li>
<p>master备份</p>
<p>master主要是<strong>维护namesapce数据信息，chunk位置信息</strong>，系统启动之后，会根据数据构建一颗b+树，并且将更新的操作追加到文件末尾，防止掉电之后，数据丢失。当系统重启之后，可以通过重放日志在内存中重新构建b+树.</p>
<p>如果不加控制的话，重做日志文件会越来越大。因此引入了checkpoint，checkpoint类似于一个快照，每次进行快照之后，都会对checkpoint之前的日志文件进行清理。在加载数据的时候，将checkpoint加载入内存中之后，再读取之后的重做日志文件即可。</p>
<p>chunk位置信息由chunk server周期性上报，不需要进行内存存储。</p>
</li>
</ul>
<h2 id="52-数据的完整性">5.2 数据的完整性</h2>
<h2 id="53-诊断工具">5.3 诊断工具</h2>
<p>通过全面而详细的诊断性日志以最低的成本来帮助我们对问题分解。</p>
<h1 id="6-测试">6. 测试</h1>
<p><strong>性能测试</strong></p>
<p><strong>经历</strong></p>
<ul>
<li>[The google file system translation](</li>
</ul>
 </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 animate-box">
                        
                            <div class="next-post">
                                <div class="next">下一篇</div>
                                <a href="https://saseke.github.io/post/redis-shi-zhan-zong-jie/">
                                    <h3 class="post-title">
                                        Redis实战-总结
                                    </h3>
                                </a>
                            </div>
                        
                    </div>
                </div>

                <div class="row">
    <div class="col-md-12 animate-box">
        
    </div>
</div>

            </div>

        </article>
    </div>
</div>

    

    <!-- 返回顶部 -->
    <div class="back-to-top">
    
        <a href="#!" id="tool-toc" class="hidden-xs hidden-sm">
            <i class="fa fa-map"></i>
        </a>
        <br>
    
    <a href="#top" class="hidden-xs hidden-sm"><i class="fa fa-paper-plane"></i></a>
</div>

<div class="post-toc animated fadeInRight hidden-xs hidden-sm" style="display: none;">
    <ul class="markdownIt-TOC">
<li><a href="#the-google-file-system"><strong>The Google File System</strong></a>
<ul>
<li><a href="#1-introduction">1. <strong>Introduction</strong></a></li>
<li><a href="#2-%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%BF%B0">2. <strong>设计概述</strong></a>
<ul>
<li><a href="#21-assumptions">2.1 Assumptions</a></li>
</ul>
</li>
<li><a href="#22-interface">2.2 Interface</a></li>
<li><a href="#23-architecture">2.3 Architecture</a></li>
<li><a href="#24-single-master">2.4 Single master</a></li>
<li><a href="#25-chunk-size">2.5 chunk size</a></li>
<li><a href="#26-metadata">2.6 metadata</a>
<ul>
<li><a href="#261-in-memory-data-structures">2.6.1 In-memory data structures</a></li>
<li><a href="#262-chunk-locations">2.6.2 Chunk locations</a></li>
<li><a href="#263-operation-log">2.6.3 Operation log</a></li>
</ul>
</li>
<li><a href="#27-consistency-model-%E8%AF%B4%E7%9A%84%E4%B8%8D%E6%98%AF%E4%BA%BA%E8%AF%9D">2.7 Consistency Model--说的不是人话</a>
<ul>
<li><a href="#271-guarantees-by-gfs">2.7.1 Guarantees by GFS</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3%E7%B3%BB%E7%BB%9F%E4%BA%A4%E4%BA%92">3.<strong>系统交互</strong></a>
<ul>
<li><a href="#31-%E7%A7%9F%E7%BA%A6%E4%B8%8E%E5%8F%98%E6%9B%B4%E9%A1%BA%E5%BA%8F">3.1 租约与变更顺序</a></li>
<li><a href="#32-%E6%95%B0%E6%8D%AE%E6%B5%81">3.2 数据流</a></li>
<li><a href="#33-%E5%8E%9F%E5%AD%90%E6%80%A7%E7%9A%84%E8%AE%B0%E5%BD%95append">3.3 原子性的记录append</a></li>
<li><a href="#34-%E5%BF%AB%E7%85%A7">3.4 快照</a></li>
</ul>
</li>
<li><a href="#4-master%E6%93%8D%E4%BD%9C"><strong>4. master操作</strong></a>
<ul>
<li><a href="#41-namespace%E7%AE%A1%E7%90%86%E5%92%8C%E9%94%81">4.1 namespace管理和锁</a></li>
<li><a href="#42-%E5%A4%87%E4%BB%BD%E6%94%BE%E7%BD%AE">4.2 备份放置</a></li>
<li><a href="#43-%E5%A4%87%E4%BB%BD%E5%88%9B%E5%BB%BA%E9%87%8D%E5%A4%87%E4%BB%BD%E9%87%8D%E5%B9%B3%E8%A1%A1">4.3 备份创建，重备份，重平衡</a></li>
<li><a href="#44-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6-%E6%96%87%E4%BB%B6%E5%BB%B6%E8%BF%9F%E5%9B%9E%E6%94%B6%E8%80%8C%E4%B8%8D%E6%98%AF%E7%9B%B4%E6%8E%A5%E5%88%A0%E9%99%A4">4.4 垃圾回收----文件延迟回收，而不是直接删除</a>
<ul>
<li><a href="#441-%E6%9C%BA%E5%88%B6">4.4.1 机制</a></li>
</ul>
</li>
<li><a href="#45-%E8%BF%87%E6%9C%9F%E5%89%AF%E6%9C%AC%E6%A3%80%E6%B5%8B">4.5 过期副本检测</a></li>
</ul>
</li>
<li><a href="#5%E5%AE%B9%E9%94%99%E5%92%8C%E8%AF%8A%E6%96%AD">5.容错和诊断</a>
<ul>
<li><a href="#51-%E9%AB%98%E5%8F%AF%E7%94%A8">5.1 高可用</a></li>
<li><a href="#52-%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%8C%E6%95%B4%E6%80%A7">5.2 数据的完整性</a></li>
<li><a href="#53-%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7">5.3 诊断工具</a></li>
</ul>
</li>
<li><a href="#6-%E6%B5%8B%E8%AF%95">6. 测试</a></li>
</ul>

</div>


    
<footer id="fh5co-footer">
  <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a></p>
</footer>


    <!-- jQuery -->
<script src="https://saseke.github.io/media/scripts/jquery.min.js"></script>
<!-- img lazy load -->
<script src="https://saseke.github.io/media/scripts/jquery.lazyload.min.js"></script>
<!-- jQuery Easing -->
<script src="https://saseke.github.io/media/scripts/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://saseke.github.io/media/scripts/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://saseke.github.io/media/scripts/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://saseke.github.io/media/scripts/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://saseke.github.io/media/scripts/md5.min.js"></script>
<!-- katex -->
<!--<script src="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.js"></script>-->
<!-- highlight -->
<script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>


<script type="application/javascript">
    // 代码高亮
    hljs.initHighlightingOnLoad();

    // img 懒加载
    $(function () {
        $("img.lazy").lazyload({
            effect: "fadeIn",  // 懒加载动画
            threshold: 180  // 在图片距离屏幕180px时提前载入
        });
        // tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // 目录
        $('#tool-toc').click(function () {
            $('.post-toc').toggle();
        });
    });

    
</script>




</body>
</html>
